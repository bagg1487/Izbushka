<!-- templates/casino.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Казино Избушка</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #8B0000;
            height: 100vh;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        .casino-container {
            display: flex;
            height: 100vh;
            background: 
                radial-gradient(circle at 20% 80%, #B22222 0%, #8B0000 20%, #800000 100%),
                repeating-linear-gradient(45deg, #8B0000 0px, #8B0000 2px, #A52A2A 2px, #A52A2A 4px);
            position: relative;
        }
        
        .casino-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse at 50% 50%, rgba(255,215,0,0.1) 0%, transparent 50%),
                linear-gradient(0deg, rgba(139,0,0,0.8) 0%, rgba(178,34,34,0.9) 100%);
            pointer-events: none;
        }
        
        .slots-section {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .reels-container {
            display: flex;
            gap: 1vw;
            align-items: center;
            background: linear-gradient(145deg, #2f2f2f, #1a1a1a);
            padding: 3vw;
            border-radius: 2vw;
            border: 1vw solid #ffd700;
            box-shadow: 
                inset 0 0 5vw rgba(0,0,0,0.8),
                0 0 10vw rgba(255,215,0,0.3);
        }
        
        .reel {
            width: 18vw;
            height: 65vh;
            background: #fff;
            border: 0.5vw solid #333;
            border-radius: 1vw;
            position: relative;
            overflow: hidden;
            box-shadow: 
                inset 0 0 2vw rgba(0,0,0,0.3),
                0 0 1vw rgba(255,255,255,0.5);
        }
        
        .reel-inner {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            transition: top 3s cubic-bezier(0.1, 0.8, 0.2, 1);
        }
        
        .reel-image {
            width: 100%;
            height: 65vh;
            object-fit: contain;
            background: white;
            border-bottom: 0.2vh solid #ddd;
            padding: 1vh;
        }
        
        .reel.spinning .reel-inner {
            transition: top 0.1s linear;
        }
        
        .win-animation .reel {
            animation: winPulse 0.3s infinite alternate;
        }
        
        @keyframes winPulse {
            0% { 
                box-shadow: 0 0 2vw gold;
                border-color: #ffd700;
            }
            100% { 
                box-shadow: 0 0 4vw #00ff00;
                border-color: #00ff00;
            }
        }
        
        .lever-section {
            width: 12vw;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .lever-container {
            position: relative;
            width: 6vw;
            height: 40vh;
        }
        
        .lever-base {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 4vw;
            height: 25vh;
            background: linear-gradient(45deg, #8B4513, #A0522D, #8B4513);
            border: 0.5vw solid #654321;
            border-radius: 2vw 2vw 1vw 1vw;
            box-shadow: 
                inset 0 0 2vw rgba(0,0,0,0.5),
                0 0.5vw 1vw rgba(0,0,0,0.7);
        }
        
        .lever-handle {
            position: absolute;
            top: 3vh;
            left: 50%;
            transform: translateX(-50%) rotate(0deg);
            width: 3vw;
            height: 20vh;
            background: linear-gradient(135deg, #c0c0c0, #e0e0e0, #a0a0a0);
            border: 0.4vw solid #808080;
            border-radius: 1.5vw;
            cursor: pointer;
            transition: transform 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            transform-origin: top center;
            z-index: 2;
            box-shadow: 
                0 0.5vw 1vw rgba(0,0,0,0.5),
                inset 0 -0.5vw 1vw rgba(255,255,255,0.3);
        }
        
        .lever-handle.pulled {
            transform: translateX(-50%) rotate(45deg);
        }
        
        .lever-handle::before {
            content: '';
            position: absolute;
            top: 1vh;
            left: 50%;
            transform: translateX(-50%);
            width: 1.5vw;
            height: 1.5vw;
            background: radial-gradient(circle, #ffd700, #b8860b);
            border-radius: 50%;
            border: 0.2vw solid #daa520;
            box-shadow: 0 0 1vw gold;
        }
        
        .result-display {
            position: absolute;
            top: 8vh;
            left: 50%;
            transform: translateX(-50%);
            font-size: 6vh;
            font-weight: bold;
            text-align: center;
            text-shadow: 
                0.2vh 0.2vh 0 #000,
                -0.2vh -0.2vh 0 #000,
                0.2vh -0.2vh 0 #000,
                -0.2vh 0.2vh 0 #000;
            z-index: 10;
            padding: 2vh 4vh;
            border-radius: 2vh;
            background: rgba(0,0,0,0.7);
            border: 0.5vh solid gold;
        }
        
        .win {
            color: #00ff00;
            animation: winText 0.5s infinite alternate;
            background: rgba(0,100,0,0.8);
        }
        
        .lose {
            color: #ff4444;
            animation: loseText 0.5s infinite alternate;
            background: rgba(100,0,0,0.8);
        }
        
        @keyframes winText {
            0% { transform: translateX(-50%) scale(1); }
            100% { transform: translateX(-50%) scale(1.1); }
        }
        
        @keyframes loseText {
            0% { opacity: 1; }
            100% { opacity: 0.8; }
        }
        
        .sparkle {
            position: absolute;
            width: 2vh;
            height: 2vh;
            background: radial-gradient(circle, gold, orange);
            border-radius: 50%;
            pointer-events: none;
            animation: sparkleFly 1s ease-out forwards;
            box-shadow: 0 0 1vh gold;
        }
        
        @keyframes sparkleFly {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: scale(1) rotate(360deg) translateY(-50vh);
                opacity: 0;
            }
        }

        .machine-decoration {
            position: absolute;
            top: 2vh;
            left: 50%;
            transform: translateX(-50%);
            font-size: 4vh;
            color: gold;
            text-shadow: 0 0 1vh rgba(255,215,0,0.8);
            z-index: 1;
        }
    </style>
</head>
<body>
    <div class="casino-container">
        <div class="machine-decoration">🎰 IZBA CASINO 🎰</div>
        
        <div class="slots-section">
            <div class="reels-container">
                <div class="reel" id="reel1">
                    <div class="reel-inner">
                        <img src="/static/slots/1.png" class="reel-image" alt="7">
                        <img src="/static/slots/2.png" class="reel-image" alt="BAR">
                        <img src="/static/slots/3.png" class="reel-image" alt="Cherry">
                        <img src="/static/slots/4.png" class="reel-image" alt="Grape">
                        <img src="/static/slots/5.png" class="reel-image" alt="Bell">
                        <img src="/static/slots/6.png" class="reel-image" alt="Diamond">
                        <img src="/static/slots/7.png" class="reel-image" alt="Horseshoe">
                    </div>
                </div>
                <div class="reel" id="reel2">
                    <div class="reel-inner">
                        <img src="/static/slots/1.png" class="reel-image" alt="7">
                        <img src="/static/slots/2.png" class="reel-image" alt="BAR">
                        <img src="/static/slots/3.png" class="reel-image" alt="Cherry">
                        <img src="/static/slots/4.png" class="reel-image" alt="Grape">
                        <img src="/static/slots/5.png" class="reel-image" alt="Bell">
                        <img src="/static/slots/6.png" class="reel-image" alt="Diamond">
                        <img src="/static/slots/7.png" class="reel-image" alt="Horseshoe">
                    </div>
                </div>
                <div class="reel" id="reel3">
                    <div class="reel-inner">
                        <img src="/static/slots/1.png" class="reel-image" alt="7">
                        <img src="/static/slots/2.png" class="reel-image" alt="BAR">
                        <img src="/static/slots/3.png" class="reel-image" alt="Cherry">
                        <img src="/static/slots/4.png" class="reel-image" alt="Grape">
                        <img src="/static/slots/5.png" class="reel-image" alt="Bell">
                        <img src="/static/slots/6.png" class="reel-image" alt="Diamond">
                        <img src="/static/slots/7.png" class="reel-image" alt="Horseshoe">
                    </div>
                </div>
            </div>
            
            <div class="result-display" id="result"></div>
        </div>
        
        <div class="lever-section">
            <div class="lever-container">
                <div class="lever-base"></div>
                <div class="lever-handle" id="leverHandle"></div>
            </div>
        </div>
    </div>

    <script>
        const ws = new WebSocket('ws://localhost:8000/ws');
        let isSpinning = false;
        const reels = ['reel1', 'reel2', 'reel3'];
        const symbolCount = 7;

        // Инициализация позиций барабанов
        reels.forEach(reelId => {
            const reel = document.getElementById(reelId);
            const reelInner = reel.querySelector('.reel-inner');
            const randomPosition = -Math.floor(Math.random() * symbolCount) * 100;
            reelInner.style.top = randomPosition + '%';
        });

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.type === 'casino_spin') {
                if (!isSpinning) {
                    spinSlots();
                }
            }
        };

        function spinSlots() {
            if (isSpinning) return;
            
            isSpinning = true;
            const leverHandle = document.getElementById('leverHandle');
            const resultElement = document.getElementById('result');
            
            // Анимация рычага
            leverHandle.classList.add('pulled');
            resultElement.textContent = '';
            resultElement.className = 'result-display';
            
            // Запуск вращения барабанов
            reels.forEach((reelId, index) => {
                const reel = document.getElementById(reelId);
                const reelInner = reel.querySelector('.reel-inner');
                
                reel.classList.add('spinning');
                
                // Быстрое вращение
                let spinCount = 0;
                const fastSpin = setInterval(() => {
                    const currentTop = parseInt(reelInner.style.top) || 0;
                    reelInner.style.top = (currentTop - 100) + '%';
                    spinCount++;
                    
                    if (spinCount > 25) {
                        clearInterval(fastSpin);
                        
                        // Медленное вращение к финальной позиции
                        const finalPosition = -Math.floor(Math.random() * symbolCount) * 100;
                        reelInner.style.transition = 'top 2.5s cubic-bezier(0.1, 0.8, 0.2, 1)';
                        reelInner.style.top = finalPosition + '%';
                        
                        setTimeout(() => {
                            reel.classList.remove('spinning');
                            
                            if (index === reels.length - 1) {
                                setTimeout(() => finishSpin(), 500);
                            }
                        }, 2500);
                    }
                }, 40);
            });
        }

        function finishSpin() {
            const leverHandle = document.getElementById('leverHandle');
            const resultElement = document.getElementById('result');
            
            // Возврат рычага
            leverHandle.classList.remove('pulled');
            
            // Проверка выигрыша
            const reelValues = reels.map(reelId => {
                const reel = document.getElementById(reelId);
                const reelInner = reel.querySelector('.reel-inner');
                const position = Math.abs(parseInt(reelInner.style.top)) / 100;
                return Math.floor(position % symbolCount);
            });
            
            // Все три одинаковые - выигрыш
            const isWin = reelValues[0] === reelValues[1] && reelValues[1] === reelValues[2];
            
            if (isWin) {
                resultElement.textContent = 'JACKPOT!';
                resultElement.className = 'result-display win';
                
                // Анимация выигрыша
                document.querySelector('.reels-container').classList.add('win-animation');
                createSparkles();
                
                setTimeout(() => {
                    document.querySelector('.reels-container').classList.remove('win-animation');
                }, 3000);
            } else {
                resultElement.textContent = 'TRY AGAIN';
                resultElement.className = 'result-display lose';
            }
            
            isSpinning = false;
        }

        function createSparkles() {
            const container = document.querySelector('.slots-section');
            for (let i = 0; i < 40; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                sparkle.style.left = Math.random() * 100 + 'vw';
                sparkle.style.top = '100vh';
                sparkle.style.animationDelay = Math.random() * 1 + 's';
                container.appendChild(sparkle);
                
                setTimeout(() => sparkle.remove(), 1000);
            }
        }

        // Клик по рычагу
        document.getElementById('leverHandle').addEventListener('click', function() {
            if (!isSpinning) {
                spinSlots();
            }
        });
    </script>
</body>
</html>